name: Claude Code Review

on:
  workflow_call:
    inputs:
      allowed_bots:
        description: 'Comma-separated list of bot names allowed to trigger reviews'
        required: false
        type: string
        default: 'google-labs-jules[bot]'
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  check-approval:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      should_review: ${{ steps.check.outputs.should_review }}
    steps:
      - name: Check if Claude already approved
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [[ "$EVENT_NAME" != "pull_request" || "$EVENT_ACTION" != "synchronize" ]]; then
            echo "should_review=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Check if Claude has already approved this PR
          approved=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" --paginate \
            --jq '[.[] | select(.user.login == "claude[bot]" and .state == "APPROVED")] | length')
          if [[ "$approved" -gt 0 ]]; then
            echo "Claude has already approved this PR, skipping review"
            echo "should_review=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_review=true" >> "$GITHUB_OUTPUT"
          fi

  claude-review:
    needs: check-approval
    if: needs.check-approval.outputs.should_review == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: ${{ inputs.allowed_bots }}
          prompt: |
            You are a code reviewer for PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            Steps:
            1. Run `gh pr diff ${{ github.event.pull_request.number }}` to get the changes.
            2. Read any CLAUDE.md files in the repo root and in directories containing changed files.
            3. Review the diff for bugs, security issues, incorrect logic, and CLAUDE.md violations.
               - Only flag issues you are confident about. No nitpicks or style suggestions.
               - Do not flag pre-existing issues unrelated to the diff.
            4. Based on your review, submit a FORMAL review (not just comments):

               If issues are found:
               - Submit a REQUEST_CHANGES review summarizing all issues.
               - Use: `gh pr review ${{ github.event.pull_request.number }} --request-changes --body "## Code Review - Changes Requested\n\n<summary and details of issues with file paths and line references>"`

               If NO issues are found:
               - Submit an APPROVE review.
               - Use: `gh pr review ${{ github.event.pull_request.number }} --approve --body "## Code Review - Approved\n\nNo issues found. Checked for bugs, security issues, and CLAUDE.md compliance."`

            IMPORTANT:
            - Always submit exactly ONE formal review using --approve or --request-changes.
            - Never use --comment. Always use --approve or --request-changes.
            - Do NOT post separate inline comments via `gh pr comment`. Put all feedback in the review body.
          settings: |
            {
              "permissions": {
                "allow": [
                  "Bash",
                  "WebFetch"
                ]
              }
            }